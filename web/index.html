<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>胃病智能体</title>
    <style>
      :root {
        --bg: #f3f5f8;
        --panel: #ffffff;
        --text: #1b1f2a;
        --muted: #6c7384;
        --line: #e3e7ef;
        --user: #e9f1ff;
        --accent: #2f6fed;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "PingFang SC", "Noto Sans SC", "Microsoft YaHei", sans-serif;
        background: radial-gradient(circle at top, #f9fbff 0%, var(--bg) 40%, #edf1f7 100%);
        color: var(--text);
      }

      .app {
        max-width: 960px;
        margin: 0 auto;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        padding: 18px 14px 20px;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .brand {
        font-size: 17px;
        font-weight: 700;
        letter-spacing: 0.2px;
      }

      .hint {
        font-size: 12px;
        color: var(--muted);
      }

      .chat {
        flex: 1;
        border: 1px solid var(--line);
        border-radius: 18px;
        background: var(--panel);
        padding: 16px;
        overflow-y: auto;
      }


      .empty {
        font-size: 14px;
        color: var(--muted);
        line-height: 1.7;
        padding: 8px 4px;
      }

      .msg {
        margin-bottom: 18px;
      }

      .msg.user {
        display: flex;
        justify-content: flex-end;
      }

      .bubble {
        max-width: 84%;
        padding: 12px 14px;
        border-radius: 16px;
        white-space: pre-wrap;
        word-break: break-word;
        line-height: 1.7;
        font-size: 15px;
      }

      .msg.user .bubble {
        background: var(--user);
        border: 1px solid #d7e5ff;
      }

      .assistant-block {
        max-width: 95%;
      }

      .thought-head {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: var(--muted);
        font-size: 13px;
        margin-bottom: 6px;
      }

      .dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: var(--accent);
        display: inline-block;
        animation: pulse 1.2s infinite ease-in-out;
      }

      @keyframes pulse {
        0% { opacity: 0.2; transform: scale(0.9); }
        50% { opacity: 1; transform: scale(1); }
        100% { opacity: 0.2; transform: scale(0.9); }
      }

      .thought,
      .answer {
        font-size: 15px;
        line-height: 1.72;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .thought {
        color: #4a5160;
        border-left: 2px solid #d8deea;
        padding-left: 10px;
        margin-bottom: 10px;
      }

      .answer {
        color: #161b25;
      }

      .sources {
        margin-top: 10px;
        font-size: 13px;
        color: var(--muted);
      }

      .sources ul {
        margin: 6px 0 0;
        padding-left: 18px;
      }

      .composer {
        margin-top: 12px;
        border: 1px solid var(--line);
        border-radius: 16px;
        background: #fff;
        padding: 10px;
      }

      .controls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 8px;
        flex-wrap: wrap;
      }

      .controls label {
        font-size: 13px;
        color: var(--muted);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .controls input[type="text"] {
        min-width: 220px;
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 6px 8px;
      }

      .composer textarea {
        width: 100%;
        min-height: 86px;
        resize: vertical;
        border: 0;
        outline: none;
        font-size: 15px;
        line-height: 1.7;
      }

      .send-row {
        display: flex;
        justify-content: flex-end;
      }

      button {
        border: 0;
        border-radius: 10px;
        background: var(--accent);
        color: #fff;
        font-size: 14px;
        padding: 9px 16px;
        cursor: pointer;
      }


      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      @media (max-width: 700px) {
        .bubble,
        .assistant-block {
          max-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="topbar">
        <div class="brand">胃病智能体</div>
        <div class="hint">思考过程先展示，答案后展示</div>
      </div>

      <div id="chat" class="chat">
        <div class="empty">你好，你可以问：
- 肠胃炎吃什么药
- 晚上反酸怎么缓解
- 胃炎和胃溃疡区别是什么</div>
      </div>

      <div class="composer">
        <div class="controls">
          <label><input id="think" type="checkbox" checked /> 深度思考</label>
          <label>知识库目录 <input id="persistDir" type="text" value="data/vector_db" /></label>
        </div>
        <textarea id="question" placeholder="输入你的问题，按 Ctrl/Command + Enter 发送"></textarea>
        <div class="send-row"><button id="sendBtn">发送</button></div>
      </div>
    </div>

    <script>
      const chatEl = document.getElementById("chat");
      const questionEl = document.getElementById("question");
      const thinkEl = document.getElementById("think");
      const persistDirEl = document.getElementById("persistDir");
      const sendBtn = document.getElementById("sendBtn");

      function scrollBottom() {
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      function removeEmpty() {
        const empty = chatEl.querySelector(".empty");
        if (empty) empty.remove();
      }

      function addUserMessage(text) {
        removeEmpty();
        const box = document.createElement("div");
        box.className = "msg user";
        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = text;
        box.appendChild(bubble);
        chatEl.appendChild(box);
        scrollBottom();
      }

      function createAssistantMessage() {
        const wrap = document.createElement("div");
        wrap.className = "msg";

        const block = document.createElement("div");
        block.className = "assistant-block";

        const head = document.createElement("div");
        head.className = "thought-head";
        head.innerHTML = '<span class="dot"></span><span>已思考 <span data-el="seconds">0</span> 秒</span>';

        const thought = document.createElement("div");
        thought.className = "thought";

        const answer = document.createElement("div");
        answer.className = "answer";

        const sources = document.createElement("div");
        sources.className = "sources";
        sources.innerHTML = "<strong>参考来源</strong><ul></ul>";

        block.appendChild(head);
        block.appendChild(thought);
        block.appendChild(answer);
        block.appendChild(sources);
        wrap.appendChild(block);
        chatEl.appendChild(wrap);

        const secEl = head.querySelector('[data-el="seconds"]');
        const timer = setInterval(() => {
          secEl.textContent = String(Number(secEl.textContent || "0") + 1);
        }, 1000);

        scrollBottom();
        return {
          thought,
          answer,
          sources: sources.querySelector("ul"),
          head,
          stopTimer: () => clearInterval(timer),
        };
      }

      function appendSource(target, url) {
        const li = document.createElement("li");
        li.textContent = url;
        target.appendChild(li);
      }

      function appendReference(target, ref) {
        const li = document.createElement("li");
        const idx = ref.idx || "?";
        const title = ref.title || "(untitled)";
        const source = ref.source || "";
        li.textContent = `[${idx}] ${title} - ${source}`;
        target.appendChild(li);
      }


      async function send() {
        const question = questionEl.value.trim();
        if (!question) return;

        sendBtn.disabled = true;
        addUserMessage(question);
        const ui = createAssistantMessage();

        questionEl.value = "";
        let buffer = "";

        try {
          const response = await fetch("/api/chat/stream", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              question,
              think_mode: thinkEl.checked,
              top_k: 5,
              persist_dir: persistDirEl.value.trim() || "data/vector_db",
            }),
          });

          if (!response.ok || !response.body) {
            throw new Error(`HTTP ${response.status}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let answerStarted = false;

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const parts = buffer.split("\n");
            buffer = parts.pop() || "";

            for (const line of parts) {
              const clean = line.trim();
              if (!clean) continue;
              const evt = JSON.parse(clean);

              if (evt.event === "reasoning") {
                ui.thought.textContent += evt.data;
              }

              if (evt.event === "answer") {
                if (!answerStarted) {
                  answerStarted = true;
                  ui.head.style.color = "#8a90a1";
                  const dot = ui.head.querySelector(".dot");
                  if (dot) dot.remove();
                }
                ui.answer.textContent += evt.data;
              }

              if (evt.event === "sources") {
                if (!ui.sources.hasChildNodes()) {
                  for (const src of evt.data || []) {
                    appendSource(ui.sources, src);
                  }
                }
              }

              if (evt.event === "references") {
                ui.sources.innerHTML = "";
                for (const ref of evt.data || []) {
                  appendReference(ui.sources, ref);
                }
              }

              if (evt.event === "error") {
                ui.answer.textContent += `\n[ERROR] ${evt.data}`;
              }
            }
            scrollBottom();
          }
        } catch (err) {
          ui.answer.textContent += `\n[ERROR] ${err.message}`;
        } finally {
          ui.stopTimer();
          sendBtn.disabled = false;
          scrollBottom();
        }
      }

      sendBtn.addEventListener("click", send);
      questionEl.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
          e.preventDefault();
          send();
        }
      });
    </script>
  </body>
</html>
